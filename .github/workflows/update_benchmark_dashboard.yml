name: Update Benchmark Dashboard
on:
  workflow_run:
    workflows: ["Performance Regression Check"]
    types:
      - completed
  # Add manual trigger option
  workflow_dispatch:

jobs:
  update-dashboard:
    runs-on: ubuntu-latest
    if: ${{github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch'}}
    permissions:
      contents: write
    steps:
      - name: Checkout code with dashboard.html
        uses: actions/checkout@v4
        with:
          ref: master
          path: source-repo

      - name: Checkout gh-pages branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages-repo
          # Add fetch-depth to avoid shallow clone issues
          fetch-depth: 0

      - name: Download benchmark artifacts
        if: ${{github.event_name != 'workflow_dispatch'}}
        uses: dawidd6/action-download-artifact@v2
        with:
          workflow: performance_regression.yml
          workflow_conclusion: success
          name: benchmark_data
          path: benchmark_data
          if_no_artifact_found: warn

      - name: Create sample data if needed
        run: |
          # If there's no benchmark_data directory, create sample data
          if [ ! -d "benchmark_data" ] || [ ! -f "benchmark_data/pr_*.json" ]; then
            echo "Creating sample benchmark data"
            mkdir -p benchmark_data
            cat > benchmark_data/sample_pr_1001.json << 'EOF'
            {
              "timestamp": "2025-03-16T12:00:00Z",
              "pr": {
                "number": "1001",
                "title": "Initial PR for dashboard demo",
                "url": "https://github.com/dlang/dmd/pull/1001",
                "commit": "abc123"
              },
              "metrics": {
                "pr_time": "10.250",
                "master_time": "10.500",
                "pr_memory": "156.4",
                "master_memory": "158.2",
                "time_diff": "-0.250",
                "time_pct": "-2.38%"
              }
            }
            EOF
          fi

      - name: Update benchmark history
        run: |
          # Create directories if they don't exist
          mkdir -p gh-pages-repo/benchmark_data

          # Initialize history.json if it doesn't exist
          if [ ! -f "gh-pages-repo/benchmark_data/history.json" ]; then
            echo "[]" > gh-pages-repo/benchmark_data/history.json
            echo "Created new history.json file"
          fi

          # Process benchmark data files
          if [ -d "benchmark_data" ]; then
            # Process all PR JSON files
            for file in benchmark_data/pr_*.json benchmark_data/sample_pr_*.json; do
              if [ -f "$file" ]; then
                echo "Processing $file"
                # Validate JSON syntax
                if ! jq empty "$file" 2>/dev/null; then
                  echo "Skipping invalid JSON file: $file"
                  continue
                fi

                # Update history.json
                jq --slurpfile newEntry "$file" \
                  '.+=$newEntry' gh-pages-repo/benchmark_data/history.json > tmp.json
                mv tmp.json gh-pages-repo/benchmark_data/history.json

                # Also copy individual PR file
                cp "$file" gh-pages-repo/benchmark_data/
              fi
            done

            # Also copy the latest results file if it exists
            if [ -f "benchmark_data/latest_results.json" ]; then
              cp benchmark_data/latest_results.json gh-pages-repo/benchmark_data/
            fi

            # Sort history by timestamp
            jq 'sort_by(.timestamp)' gh-pages-repo/benchmark_data/history.json > tmp.json
            mv tmp.json gh-pages-repo/benchmark_data/history.json
          fi

          # Copy latest dashboard HTML
          cp source-repo/dashboard.html gh-pages-repo/

          # Debug: list benchmark_data directory contents
          echo "Content of gh-pages-repo/benchmark_data:"
          ls -la gh-pages-repo/benchmark_data/

      - name: Commit and push changes
        run: |
          cd gh-pages-repo
          git add benchmark_data/*.json dashboard.html

          # Check for changes using git status
          if [ -n "$(git status --porcelain)" ]; then
            git config --local user.email "action@github.com"
            git config --local user.name "GitHub Action"
            git commit -m "Update benchmark data [skip ci]"
            git push origin HEAD:gh-pages
            echo "Changes pushed successfully"
          else
            echo "No changes to commit"
          fi
