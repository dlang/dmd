name: Update GitHub Pages
on:
  workflow_dispatch:
  push:
    branches:
      - master
    paths:
      - 'dashboard.html'

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Debug repository structure
        run: |
          echo "Repository root contents:"
          ls -la
          echo "Current branch: $(git branch --show-current)"

      - name: Setup git identity
        run: |
          git config --global user.email "github-actions@github.com"
          git config --global user.name "GitHub Actions"

      - name: Prepare deploy folder
        run: |
          mkdir -p _temp
          # Look for the dashboard.html file
          dashboard_path=$(find . -name "dashboard.html" -type f | head -1)
          if [ -n "$dashboard_path" ]; then
            echo "Found dashboard at: $dashboard_path"
            cp "$dashboard_path" _temp/index.html
          else
            echo "ERROR: dashboard.html not found in repository"
            exit 1
          fi

      # Create and push a basic gh-pages branch before using the action
      - name: Initialize gh-pages branch
        run: |
          # Check if gh-pages exists remotely
          if ! git ls-remote --exit-code --heads origin gh-pages; then
            echo "Creating gh-pages branch..."
            # Create orphan branch
            git checkout --orphan gh-pages
            # Remove everything
            git rm -rf .
            # Create a basic file
            echo "# Dashboard Page" > README.md
            git add README.md
            git commit -m "Initialize gh-pages branch"
            git push origin gh-pages
            # Return to the original branch
            git checkout -f ${GITHUB_REF#refs/heads/}
          else
            echo "gh-pages branch already exists"
          fi

      # Alternative deployment approach using git commands directly
      - name: Deploy to GitHub Pages manually
        run: |
          cd _temp
          git init
          git config user.name "GitHub Actions"
          git config user.email "github-actions@github.com"
          git add .
          git commit -m "Update dashboard"
          git branch -M gh-pages
          git remote add origin https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
          git push -f origin gh-pages
